<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ID TENSOR: OMEGA ARCHITECT (PERFECTED CORE)</title>
    <style>
        :root { --main: #00ffa3; --accent: #00d4ff; --warn: #ffcc00; --danger: #ff0055; --bg: #050505; --panel: #0d0d0d; --tensor: #b400ff;}
        body { background: var(--bg); color: #e0e0e0; font-family: sans-serif; padding: 10px; display: flex; flex-direction: column; align-items: center; margin: 0; overflow-y: auto; overflow-x: hidden; }
        h1 { color: var(--main); border-bottom: 2px solid var(--main); padding-bottom: 5px; margin: 10px 0; font-size: 1.4rem; letter-spacing: 2px; text-shadow: 0 0 15px rgba(0,255,163,0.4);}
        .container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 320px 1fr; gap: 15px; margin-bottom: 50px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
        .panel { background: var(--panel); border: 1px solid #333; padding: 15px; border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.8); display: flex; flex-direction: column; }
        .panel-title { font-size: 0.8rem; color: #888; border-bottom: 1px dashed #444; padding-bottom: 5px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;}
        .slider-row { margin-bottom: 12px; }
        .slider-label { font-size: 0.75rem; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 4px;}
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--main); }
        .target-box { background: #110022; border: 1px solid var(--tensor); padding: 15px; border-radius: 6px; text-align: center; margin: 15px 0; box-shadow: inset 0 0 10px rgba(180,0,255,0.2);}
        .target-val { font-size: 2rem; color: var(--tensor); font-weight: bold; font-family: monospace; text-shadow: 0 0 10px rgba(180,0,255,0.5);}
        .btn { background: #1a1a1a; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.85rem; transition: 0.2s; margin-bottom: 5px;}
        .btn:hover { border-color: var(--accent); color: var(--accent); background: #001122;}
        .btn-main { background: #001a11; border-color: var(--main); color: var(--main); width: 100%; margin: 10px 0; font-size: 1rem; padding: 12px;}
        .btn-main:hover { background: #003322; box-shadow: 0 0 15px rgba(0,255,163,0.3); }
        select { background: #111; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; width: 100%; margin-bottom: 10px; font-family: monospace; font-size: 1rem;}
        .ingredient-list { display: flex; flex-wrap: wrap; gap: 6px; min-height: 55px; padding: 10px; background: #000; border: 1px solid #222; margin-bottom: 10px; border-radius: 4px; }
        .chip { background: #1a1a1a; padding: 6px 12px; border-radius: 4px; font-size: 0.9rem; border: 1px solid #444; display: flex; align-items: center; gap: 8px; }
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 10px; }
        .dash-box { background: #0a0a0a; border: 1px solid #333; padding: 10px; border-radius: 6px; text-align: center; display: flex; flex-direction: column; justify-content: center;}
        .dash-label { font-size: 0.6rem; color: #888; text-transform: uppercase; margin-bottom: 3px;}
        .dash-val { font-size: 1.1rem; font-family: monospace; font-weight: bold; color: #ddd;}
        #networkCanvas { background: radial-gradient(circle at center, #111 0%, #000 100%); border: 1px solid #333; width: 100%; min-height: 600px; border-radius: 6px; position: relative; overflow: hidden; margin-top: 10px; touch-action: none; cursor: grab; }
        .node { position: absolute; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem; border: 2px solid #fff; box-shadow: inset -3px -3px 8px rgba(0,0,0,0.6), 0 0 10px rgba(255,255,255,0.1); pointer-events: none; }
        .bond-line { position: absolute; background: linear-gradient(90deg, #555, #aaa, #555); height: 5px; transform-origin: 0 50%; z-index: 1; pointer-events: none; opacity: 0.8; border-radius: 2.5px; box-shadow: 0 0 5px rgba(0,0,0,0.5);}
    </style>
</head>
<body>
    <h1>ID TENSOR: OMEGA ARCHITECT</h1>
    <div class="container">
        <div class="panel">
            <div class="panel-title">1. Tensor Modulator</div>
            
            <div class="slider-row">
                <div class="slider-label"><span>Conductivity (Metals)</span><span id="vCond">50%</span></div>
                <input type="range" id="slCond" value="50" oninput="updateUIValues()">
            </div>
            <div class="slider-row">
                <div class="slider-label"><span>Polarity (High EN)</span><span id="vPol">50%</span></div>
                <input type="range" id="slPol" value="50" oninput="updateUIValues()">
            </div>
            <div class="slider-row">
                <div class="slider-label"><span>Hardness (Networks)</span><span id="vHard">50%</span></div>
                <input type="range" id="slHard" value="50" oninput="updateUIValues()">
            </div>
            
            <div class="target-box">
                <div style="font-size:0.7rem; color:#aaa; margin-bottom:5px;">Optimal S-Value (Target)</div>
                <div class="target-val" id="dispTargetS">0.000</div>
            </div>

            <div class="slider-row" style="margin-top:20px;">
                <div class="slider-label"><span style="color:#f66;">Kinetic Energy (Temp)</span><span id="vTemp" style="color:#f66;">0 K</span></div>
                <input type="range" id="slTemp" min="0" max="1000" value="0" oninput="document.getElementById('vTemp').innerText=this.value+' K'">
                <div style="font-size:0.6rem; color:#666; margin-top:4px;">‚ÄªÊâãÂãï„ÅßÂæÆÂ∞è„Å™Êè∫„Çâ„Åé„Çí‰∏é„Åà„Åü„ÅÑÂ†¥Âêà„Å´‰ΩøÁî®„ÄÇ</div>
            </div>

            <button class="btn btn-main" onclick="oracleAssemble()">üîÆ Oracle Auto-Assemble</button>
        </div>

        <div class="panel">
            <div class="panel-title">2. True Geometry Console</div>
            
            <div style="background:#0a0a0a; padding:15px; border:1px solid #333; border-radius:6px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <div><span style="font-size:0.65rem; color:#888; letter-spacing:1px;">MOLECULAR FORMULA</span><div id="formulaDisplay" style="font-size:1.8rem; font-weight:bold; color:var(--main); font-family:serif; margin-top:4px;">--</div></div>
                <div id="stabilityBadge" style="padding:8px 20px; border-radius:4px; font-weight:bold; font-size:0.9rem; background:#222; border:1px solid #444;">Êú™ÊàêÁ´ã</div>
            </div>
            
            <select id="elemSelect"></select>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn" style="flex:1" onclick="addElement()">Ôºã ÊâãÂãïËøΩÂä†</button>
                <button class="btn" style="background:#300; border-color:#600; color:#ffaaaa;" onclick="clearList()">ÂÖ®Ê∂àÂéª</button>
            </div>
            
            <div id="ingredientList" class="ingredient-list"></div>
            
            <div class="dash-grid">
                <div class="dash-box"><div class="dash-label">Z-Avg</div><div class="dash-val" id="propCond">--</div></div>
                <div class="dash-box"><div class="dash-label">ŒîEN</div><div class="dash-val" id="propPol">--</div></div>
                <div class="dash-box"><div class="dash-label">Val-Avg</div><div class="dash-val" id="propHard">--</div></div>
                <div class="dash-box"><div class="dash-label">Mean Œ∏</div><div class="dash-val" id="dispAngle">--</div></div>
                <div class="dash-box"><div class="dash-label">S-Dev</div><div class="dash-val" id="dispDist" style="color:var(--main);">--</div></div>
                <div class="dash-box" style="border-color:var(--tensor); background:#110022;"><div class="dash-label" style="color:var(--tensor);">Calc S</div><div class="dash-val" id="dispCurrentS" style="color:var(--tensor);">--</div></div>
            </div>
            
            <div id="networkCanvas"></div>
        </div>
    </div>

<script>
// --- „Éá„Éº„Çø„Éô„Éº„Çπ (Ê©üËÉΩ„ÇíÂâä„Çâ„Å™„ÅÑ‰∏ªË¶Å118ÂÖÉÁ¥†Áæ§) ---

const DB = [
    // --- Á¨¨1Âë®Êúü ---
    {z:1,s:'H',en:2.20,ie:13.60,r:0.37,pot:1,c:'#FFFFFF',type:'term'},
    {z:2,s:'He',en:0.00,ie:24.59,r:0.32,pot:0,c:'#D9FFFF',type:'noble'},
    // --- Á¨¨2Âë®Êúü ---
    {z:3,s:'Li',en:0.98,ie:5.39,r:1.34,pot:1,c:'#CC80FF',type:'metal'},
    {z:4,s:'Be',en:1.57,ie:9.32,r:0.90,pot:2,c:'#C2FF00',type:'metal'},
    {z:5,s:'B',en:2.04,ie:8.30,r:0.82,pot:3,c:'#FFB5B5',type:'hard'},
    {z:6,s:'C',en:2.55,ie:11.26,r:0.77,pot:4,c:'#909090',type:'hard'},
    {z:7,s:'N',en:3.04,ie:14.53,r:0.75,pot:3,c:'#3050F8',type:'pol'},
    {z:8,s:'O',en:3.44,ie:13.62,r:0.73,pot:2,c:'#FF0000',type:'pol'},
    {z:9,s:'F',en:3.98,ie:17.42,r:0.71,pot:1,c:'#90E050',type:'pol'},
    {z:10,s:'Ne',en:0.00,ie:21.56,r:0.69,pot:0,c:'#B3E3F5',type:'noble'},
    // --- Á¨¨3Âë®Êúü ---
    {z:11,s:'Na',en:0.93,ie:5.14,r:1.54,pot:1,c:'#AB5CF2',type:'metal'},
    {z:12,s:'Mg',en:1.31,ie:7.65,r:1.30,pot:2,c:'#8AFF00',type:'metal'},
    {z:13,s:'Al',en:1.61,ie:5.99,r:1.18,pot:3,c:'#BFA6A6',type:'metal'},
    {z:14,s:'Si',en:1.90,ie:8.15,r:1.11,pot:4,c:'#F0C8A0',type:'hard'},
    {z:15,s:'P',en:2.19,ie:10.48,r:1.06,pot:5,c:'#FF8000',type:'hard'},
    {z:16,s:'S',en:2.58,ie:10.36,r:1.02,pot:6,c:'#FFFF30',type:'pol'},
    {z:17,s:'Cl',en:3.16,ie:12.97,r:0.99,pot:1,c:'#1FF01F',type:'pol'},
    {z:18,s:'Ar',en:0.00,ie:15.76,r:0.97,pot:0,c:'#80D1E3',type:'noble'},
    // --- Á¨¨4Âë®Êúü ---
    {z:19,s:'K',en:0.82,ie:4.34,r:1.96,pot:1,c:'#8F40D4',type:'metal'},
    {z:20,s:'Ca',en:1.00,ie:6.11,r:1.74,pot:2,c:'#3DFF00',type:'metal'},
    {z:21,s:'Sc',en:1.36,ie:6.56,r:1.44,pot:3,c:'#E6E6E6',type:'metal'},
    {z:22,s:'Ti',en:1.54,ie:6.83,r:1.36,pot:4,c:'#BFC2C7',type:'metal'},
    {z:23,s:'V',en:1.63,ie:6.75,r:1.25,pot:5,c:'#A6A6AB',type:'metal'},
    {z:24,s:'Cr',en:1.66,ie:6.77,r:1.27,pot:6,c:'#8A99C7',type:'metal'},
    {z:25,s:'Mn',en:1.55,ie:7.43,r:1.39,pot:2,c:'#9C7AC7',type:'metal'},
    {z:26,s:'Fe',en:1.83,ie:7.90,r:1.25,pot:3,c:'#E06633',type:'metal'},
    {z:27,s:'Co',en:1.88,ie:7.88,r:1.26,pot:2,c:'#F090A0',type:'metal'},
    {z:28,s:'Ni',en:1.91,ie:7.64,r:1.21,pot:2,c:'#50D050',type:'metal'},
    {z:29,s:'Cu',en:1.90,ie:7.73,r:1.38,pot:2,c:'#C88033',type:'metal'},
    {z:30,s:'Zn',en:1.65,ie:9.39,r:1.31,pot:2,c:'#7D80B0',type:'metal'},
    {z:31,s:'Ga',en:1.81,ie:6.00,r:1.26,pot:3,c:'#C28F8F',type:'metal'},
    {z:32,s:'Ge',en:2.01,ie:7.90,r:1.22,pot:4,c:'#668F8F',type:'hard'},
    {z:33,s:'As',en:2.18,ie:9.81,r:1.19,pot:5,c:'#BD80E3',type:'hard'},
    {z:34,s:'Se',en:2.55,ie:9.75,r:1.16,pot:2,c:'#FFA100',type:'pol'},
    {z:35,s:'Br',en:2.96,ie:11.81,r:1.14,pot:1,c:'#A62929',type:'pol'},
    {z:36,s:'Kr',en:3.00,ie:14.00,r:1.10,pot:0,c:'#5CB8D1',type:'noble'},
    // --- Á¨¨5Âë®Êúü ---
    {z:37,s:'Rb',en:0.82,ie:4.18,r:2.11,pot:1,c:'#702EB0',type:'metal'},
    {z:38,s:'Sr',en:0.95,ie:5.69,r:1.92,pot:2,c:'#00FF00',type:'metal'},
    {z:39,s:'Y',en:1.22,ie:6.22,r:1.62,pot:3,c:'#94FFFF',type:'metal'},
    {z:40,s:'Zr',en:1.33,ie:6.63,r:1.48,pot:4,c:'#94E0E0',type:'metal'},
    {z:41,s:'Nb',en:1.60,ie:6.76,r:1.37,pot:5,c:'#73C2C9',type:'metal'},
    {z:42,s:'Mo',en:2.16,ie:7.09,r:1.45,pot:6,c:'#54B5B5',type:'metal'},
    {z:43,s:'Tc',en:1.90,ie:7.28,r:1.56,pot:7,c:'#3B9E9E',type:'metal'},
    {z:44,s:'Ru',en:2.20,ie:7.36,r:1.26,pot:3,c:'#248F8F',type:'metal'},
    {z:45,s:'Rh',en:2.28,ie:7.46,r:1.35,pot:3,c:'#0A7D8C',type:'metal'},
    {z:46,s:'Pd',en:2.20,ie:8.34,r:1.31,pot:2,c:'#006985',type:'metal'},
    {z:47,s:'Ag',en:1.93,ie:7.58,r:1.53,pot:1,c:'#C0C0C0',type:'metal'},
    {z:48,s:'Cd',en:1.69,ie:8.99,r:1.48,pot:2,c:'#FFD98F',type:'metal'},
    {z:49,s:'In',en:1.78,ie:5.79,r:1.44,pot:3,c:'#A67573',type:'metal'},
    {z:50,s:'Sn',en:1.96,ie:7.34,r:1.41,pot:4,c:'#668080',type:'hard'},
    {z:51,s:'Sb',en:2.05,ie:8.61,r:1.38,pot:5,c:'#9E63B5',type:'hard'},
    {z:52,s:'Te',en:2.10,ie:9.01,r:1.35,pot:2,c:'#D47A00',type:'pol'},
    {z:53,s:'I',en:2.66,ie:10.45,r:1.33,pot:1,c:'#940094',type:'pol'},
    {z:54,s:'Xe',en:2.60,ie:12.13,r:1.30,pot:0,c:'#429EB0',type:'noble'},
    // --- Á¨¨6Âë®Êúü ---
    {z:55,s:'Cs',en:0.79,ie:3.89,r:2.25,pot:1,c:'#57178F',type:'metal'},
    {z:56,s:'Ba',en:0.89,ie:5.21,r:1.98,pot:2,c:'#00C900',type:'metal'},
    {z:57,s:'La',en:1.10,ie:5.58,r:1.69,pot:3,c:'#70D4FF',type:'metal'},
    {z:58,s:'Ce',en:1.12,ie:5.54,r:1.69,pot:3,c:'#FFFFC7',type:'metal'},
    {z:59,s:'Pr',en:1.13,ie:5.47,r:1.69,pot:3,c:'#D9FFC7',type:'metal'},
    {z:60,s:'Nd',en:1.14,ie:5.53,r:1.69,pot:3,c:'#C7FFC7',type:'metal'},
    {z:61,s:'Pm',en:1.13,ie:5.58,r:1.68,pot:3,c:'#A3FFC7',type:'metal'},
    {z:62,s:'Sm',en:1.17,ie:5.64,r:1.68,pot:3,c:'#8FFFC7',type:'metal'},
    {z:63,s:'Eu',en:1.20,ie:5.67,r:1.68,pot:3,c:'#61FFC7',type:'metal'},
    {z:64,s:'Gd',en:1.20,ie:6.15,r:1.69,pot:3,c:'#45FFC7',type:'metal'},
    {z:65,s:'Tb',en:1.20,ie:5.86,r:1.68,pot:3,c:'#30FFC7',type:'metal'},
    {z:66,s:'Dy',en:1.22,ie:5.94,r:1.67,pot:3,c:'#1FFFC7',type:'metal'},
    {z:67,s:'Ho',en:1.23,ie:6.02,r:1.66,pot:3,c:'#00FF9C',type:'metal'},
    {z:68,s:'Er',en:1.24,ie:6.11,r:1.65,pot:3,c:'#00E675',type:'metal'},
    {z:69,s:'Tm',en:1.25,ie:6.18,r:1.64,pot:3,c:'#00D452',type:'metal'},
    {z:70,s:'Yb',en:1.10,ie:6.25,r:1.70,pot:3,c:'#00BF38',type:'metal'},
    {z:71,s:'Lu',en:1.27,ie:5.43,r:1.60,pot:3,c:'#00AB24',type:'metal'},
    {z:72,s:'Hf',en:1.30,ie:6.83,r:1.50,pot:4,c:'#4DC2FF',type:'metal'},
    {z:73,s:'Ta',en:1.50,ie:7.55,r:1.38,pot:5,c:'#4DA6FF',type:'metal'},
    {z:74,s:'W',en:2.36,ie:7.86,r:1.46,pot:6,c:'#2194D6',type:'metal'},
    {z:75,s:'Re',en:1.90,ie:7.83,r:1.59,pot:7,c:'#267DAB',type:'metal'},
    {z:76,s:'Os',en:2.20,ie:8.44,r:1.28,pot:4,c:'#266696',type:'metal'},
    {z:77,s:'Ir',en:2.20,ie:8.97,r:1.37,pot:3,c:'#175487',type:'metal'},
    {z:78,s:'Pt',en:2.28,ie:8.96,r:1.28,pot:4,c:'#D0D0E0',type:'metal'},
    {z:79,s:'Au',en:2.54,ie:9.23,r:1.44,pot:3,c:'#FFD123',type:'metal'},
    {z:80,s:'Hg',en:2.00,ie:10.44,r:1.49,pot:2,c:'#B8B8D0',type:'metal'},
    {z:81,s:'Tl',en:1.62,ie:6.11,r:1.48,pot:3,c:'#A6544D',type:'metal'},
    {z:82,s:'Pb',en:2.33,ie:7.42,r:1.47,pot:4,c:'#575961',type:'metal'},
    {z:83,s:'Bi',en:2.02,ie:7.29,r:1.46,pot:3,c:'#9E4FB5',type:'metal'},
    {z:84,s:'Po',en:2.00,ie:8.41,r:1.46,pot:2,c:'#AB5C00',type:'metal'},
    {z:85,s:'At',en:2.20,ie:9.30,r:1.45,pot:1,c:'#754F45',type:'pol'},
    {z:86,s:'Rn',en:2.20,ie:10.75,r:1.42,pot:0,c:'#428296',type:'noble'},
    // --- Á¨¨7Âë®Êúü ---
    {z:87,s:'Fr',en:0.70,ie:3.90,r:2.60,pot:1,c:'#420066',type:'metal'},
    {z:88,s:'Ra',en:0.90,ie:5.28,r:2.21,pot:2,c:'#007D00',type:'metal'},
    {z:89,s:'Ac',en:1.10,ie:5.17,r:2.15,pot:3,c:'#70ABFA',type:'metal'},
    {z:90,s:'Th',en:1.30,ie:6.08,r:2.06,pot:4,c:'#00BAFF',type:'metal'},
    {z:91,s:'Pa',en:1.50,ie:5.89,r:2.00,pot:5,c:'#00A1FF',type:'metal'},
    {z:92,s:'U',en:1.38,ie:6.19,r:1.96,pot:6,c:'#008FFF',type:'metal'},
    {z:93,s:'Np',en:1.36,ie:6.27,r:1.90,pot:5,c:'#0080FF',type:'metal'},
    {z:94,s:'Pu',en:1.28,ie:6.03,r:1.87,pot:4,c:'#006BFF',type:'metal'},
    {z:95,s:'Am',en:1.13,ie:5.97,r:1.80,pot:3,c:'#545CF2',type:'metal'},
    {z:96,s:'Cm',en:1.28,ie:5.99,r:1.69,pot:3,c:'#785CE3',type:'metal'},
    {z:97,s:'Bk',en:1.30,ie:6.20,r:1.68,pot:3,c:'#8A4FE3',type:'metal'},
    {z:98,s:'Cf',en:1.30,ie:6.28,r:1.68,pot:3,c:'#A136D4',type:'metal'},
    {z:99,s:'Es',en:1.30,ie:6.42,r:1.65,pot:3,c:'#B31FD4',type:'metal'},
    {z:100,s:'Fm',en:1.30,ie:6.50,r:1.67,pot:3,c:'#B31FBA',type:'metal'},
    {z:101,s:'Md',en:1.30,ie:6.58,r:1.73,pot:3,c:'#B30DA6',type:'metal'},
    {z:102,s:'No',en:1.30,ie:6.65,r:1.76,pot:3,c:'#BD0D87',type:'metal'},
    {z:103,s:'Lr',en:1.30,ie:4.90,r:1.61,pot:3,c:'#C70066',type:'metal'},
    {z:104,s:'Rf',en:1.30,ie:6.00,r:1.50,pot:4,c:'#CC0059',type:'metal'},
    {z:105,s:'Db',en:1.30,ie:6.00,r:1.49,pot:5,c:'#D1004F',type:'metal'},
    {z:106,s:'Sg',en:1.30,ie:6.00,r:1.48,pot:6,c:'#D90045',type:'metal'},
    {z:107,s:'Bh',en:1.30,ie:6.00,r:1.47,pot:7,c:'#E00038',type:'metal'},
    {z:108,s:'Hs',en:1.30,ie:6.00,r:1.46,pot:8,c:'#E6002E',type:'metal'},
    {z:109,s:'Mt',en:1.30,ie:6.00,r:1.45,pot:9,c:'#EB0026',type:'metal'},
    {z:110,s:'Ds',en:1.30,ie:6.00,r:1.44,pot:8,c:'#F0001C',type:'metal'},
    {z:111,s:'Rg',en:1.30,ie:6.00,r:1.43,pot:3,c:'#F50014',type:'metal'},
    {z:112,s:'Cn',en:1.30,ie:6.00,r:1.42,pot:2,c:'#FA000A',type:'metal'},
    {z:113,s:'Nh',en:1.30,ie:6.00,r:1.41,pot:3,c:'#FF0000',type:'metal'},
    {z:114,s:'Fl',en:1.30,ie:6.00,r:1.40,pot:4,c:'#FF0000',type:'metal'},
    {z:115,s:'Mc',en:1.30,ie:6.00,r:1.39,pot:3,c:'#FF0000',type:'metal'},
    {z:116,s:'Lv',en:1.30,ie:6.00,r:1.38,pot:2,c:'#FF0000',type:'metal'},
    {z:117,s:'Ts',en:1.30,ie:6.00,r:1.37,pot:1,c:'#FF0000',type:'pol'},
    {z:118,s:'Og',en:1.30,ie:6.00,r:1.36,pot:0,c:'#FF0000',type:'noble'}
];
// S2N2 10Ê¨°ÂÖÉ„ÉÜ„É≥„ÇΩ„É´Èáç„Åø„Éô„ÇØ„Éà„É´
const WEIGHTS = [-4.31678964, -20.76677434, 5.33862748, 3.56833816, -0.6491174, -0.28328967, -0.71915269, 1.32266953, 9.22544437, -2.38343102];

let uidCount=0, curAtoms=[], nodes=[], edges=[], targetS=0, animId, globalS=0, meanAngle=0;
const canvas = document.getElementById('networkCanvas');
const sel = document.getElementById('elemSelect');
DB.forEach(e => { let o=document.createElement('option'); o.value=e.z; o.text=`[${String(e.z).padStart(3,'0')}] ${e.s}`; if(e.z===6)o.selected=true; sel.appendChild(o); });

// --- UIÈÄ£Âãï ---
function updateUIValues() { 
    let c = parseInt(document.getElementById('slCond').value);
    let p = parseInt(document.getElementById('slPol').value);
    let h = parseInt(document.getElementById('slHard').value);
    
    document.getElementById('vCond').innerText = c + '%'; 
    document.getElementById('vPol').innerText = p + '%'; 
    document.getElementById('vHard').innerText = h + '%';
    
    targetS = (c/1000) + (p/666) + (h/2000); 
    document.getElementById('dispTargetS').innerText = targetS.toFixed(3); 
}

function addElement() { curAtoms.push({...DB.find(e=>e.z==sel.value), id:uidCount++}); updateUIList(); buildTopology(); }
function clearList() { curAtoms=[]; nodes=[]; edges=[]; updateUIList(); canvas.innerHTML=''; }
function removeAt(id) { curAtoms = curAtoms.filter(a=>a.id!==id); updateUIList(); buildTopology(); }
function updateUIList() { 
    let list = document.getElementById('ingredientList'); list.innerHTML = ""; 
    curAtoms.forEach(a => { 
        let d=document.createElement('div'); d.className='chip'; 
        d.innerHTML=`<b style="color:${a.c}; text-shadow:0 0 5px #000;">${a.s}</b><span style="cursor:pointer; color:#888; margin-left:8px; font-weight:bold;" onclick='removeAt(${a.id})'>√ó</span>`; 
        list.appendChild(d); 
    }); 
}

// --- „Çπ„É©„Ç§„ÉÄ„ÉºÈÄ£Âãï „Ç™„É©„ÇØ„É´ÁîüÊàê ---
function oracleAssemble() {
    curAtoms = [];
    let wCond = parseInt(document.getElementById('slCond').value) + 1;
    let wPol = parseInt(document.getElementById('slPol').value) + 1;
    let wHard = parseInt(document.getElementById('slHard').value) + 1;
    
    let totalW = wCond + wPol + wHard;
    let pMet = wCond / totalW;
    let pPol = wPol / totalW;
    
    let metals = DB.filter(e => e.type === 'metal');
    let polars = DB.filter(e => e.type === 'pol');
    let hards = DB.filter(e => e.type === 'hard');
    
    let coreCount = Math.floor(Math.random() * 5) + 6;
    let potSum = 0;
    
    for(let i=0; i<coreCount; i++) {
        let r = Math.random();
        let group = hards; 
        if(r < pMet) group = metals;
        else if(r < pMet + pPol) group = polars;
        
        if(group.length === 0) group = hards;
        
        let def = group[Math.floor(Math.random() * group.length)];
        curAtoms.push({...def, id:uidCount++}); 
        potSum += def.pot;
    }
    
    let reqH = Math.max(0, potSum - 2 * (coreCount - 1));
    for(let i=0; i<reqH; i++) {
        curAtoms.push({...DB.find(e=>e.z==1), id:uidCount++});
    }
    
    updateUIList(); 
    buildTopology();
}

// --- ÂàÜË£Ç„Åï„Åõ„Å™„ÅÑÂçò‰∏Ä„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊßãÁØâ ---
function buildTopology() {
    if(!curAtoms.length) { canvas.innerHTML=''; return; }
    
    nodes = curAtoms.map(a => { 
        return {...a, rem:a.pot, conns:[], 
                x: (Math.random()-0.5)*200, 
                y: (Math.random()-0.5)*200, 
                z: (Math.random()-0.5)*200}; 
    });
    edges = [];

    let unassigned = [...nodes].sort((a,b)=>b.pot-a.pot); 
    if(unassigned.length === 0) return;
    let connected = [unassigned.shift()]; 

    while(unassigned.length > 0) {
        let parent = connected.find(n => n.rem > 0);
        if(!parent) break; 
        
        let child = unassigned.shift();
        edges.push({s:parent, t:child});
        parent.rem--; child.rem--;
        parent.conns.push(child); child.conns.push(parent);
        connected.push(child);
    }

    for(let i=0; i<connected.length; i++) {
        for(let j=i+1; j<connected.length; j++) {
            let n1 = connected[i], n2 = connected[j];
            if(n1.rem > 0 && n2.rem > 0 && !n1.conns.includes(n2)) {
                edges.push({s:n1, t:n2});
                n1.rem--; n2.rem--;
                n1.conns.push(n2); n2.conns.push(n1);
            }
        }
    }
    
    canvas.innerHTML=''; 
    if(!animId) runGeometrySolver();
}

function getSValue(n) {
    if(n.conns.length < 2) return 0;
    const feat = [1, n.en, n.ie, n.r, n.en**2, n.ie**2, n.r**2, n.en*n.ie, n.en*n.r, n.ie*n.r];
    let S = 0; feat.forEach((v, i) => S += v * WEIGHTS[i]); 
    return Math.min(0.495, Math.max(0.005, S)); 
}

// --- Á©∂Ê•µ„ÅÆPBD„ÇΩ„É´„Éê„Éº („ÇΩ„Éï„ÉàÂèçÁô∫ÔºãËª∏Êçª„ÇäÔºãÈÄöÈÅéË®±ÂÆπ) ---
function runGeometrySolver() {
    let tS = 0, tA = 0, aC = 0;
    let SCALE = 65; 
    let temp = parseInt(document.getElementById('slTemp').value);
    let noise = (temp / 1000) * 3.0; // ÊâãÂãï„ÅÆÂæÆÂ∞èÊè∫„Çâ„Åé

    for(let iter=0; iter<5; iter++) {
        
        if(noise > 0) {
            nodes.forEach(n => {
                n.x += (Math.random()-0.5)*noise;
                n.y += (Math.random()-0.5)*noise;
                n.z += (Math.random()-0.5)*noise;
            });
        }

        // 1. „ÇΩ„Éï„Éà„Å™ÂèçÁô∫ÔºàÈÄöÈÅéË®±ÂÆπÔºâ
        for(let i=0; i<nodes.length; i++){
            for(let j=i+1; j<nodes.length; j++){
                let a = nodes[i], b = nodes[j];
                if(!a.conns.includes(b)) {
                    let dx = b.x - a.x, dy = b.y - a.y, dz = b.z - a.z;
                    let d = Math.sqrt(dx*dx + dy*dy + dz*dz) || 0.001;
                    let minDist = (a.r + b.r) * SCALE * 0.8; // ÁµêÂêà„Çà„ÇäÂ∞ë„ÅóÁã≠„ÅÑÁØÑÂõ≤„ÅßÂèçÁô∫
                    if(d < minDist) {
                        // Ë∑ùÈõ¢„Å´Âøú„Åò„Å¶ÂÑ™„Åó„ÅèÂèçÁô∫„Åï„Åõ„Çã„ÄÇÂº∑„ÅÑÂäõ„Åå„Åã„Åã„Çå„Å∞„Åô„ÇäÊäú„Åë„Çã„ÄÇ
                        let force = (minDist - d) * 0.05; 
                        a.x -= (dx/d) * force; a.y -= (dy/d) * force; a.z -= (dz/d) * force;
                        b.x += (dx/d) * force; b.y += (dy/d) * force; b.z += (dz/d) * force;
                    }
                }
            }
        }

        // 2. „Ç¥„É†Á¥ê„ÅÆÂºµÂäõÔºàÁµêÂêàË∑ùÈõ¢„ÅÆÁ∂≠ÊåÅÔºâ
        edges.forEach(e => {
            let dx = e.t.x - e.s.x, dy = e.t.y - e.s.y, dz = e.t.z - e.s.z;
            let currentDist = Math.sqrt(dx*dx + dy*dy + dz*dz) || 0.001;
            let idealDist = (e.s.r + e.t.r) * SCALE; 
            
            let diff = (currentDist - idealDist) * 0.2; 
            e.s.x += (dx/currentDist) * diff; e.s.y += (dy/currentDist) * diff; e.s.z += (dz/currentDist) * diff;
            e.t.x -= (dx/currentDist) * diff; e.t.y -= (dy/currentDist) * diff; e.t.z -= (dz/currentDist) * diff;
        });

        // 3. Á£ÅÁü≥„ÅÆÂèçÁô∫ÔºàS2N2ËßíÂ∫¶„Å´Âü∫„Å•„Åè„ÉØ„Ç§„É§„ÉºËª∏„ÅÆÊçª„ÇäÔºâ
        nodes.forEach(n => {
            if(n.conns.length < 2) return;
            let S = getSValue(n);
            let ang = Math.acos(S / (S - 1)); 
            
            if(iter === 0) { tS += S; tA += ang * 180 / Math.PI; aC++; }

            for(let i=0; i<n.conns.length; i++){
                for(let j=i+1; j<n.conns.length; j++){
                    let c1 = n.conns[i], c2 = n.conns[j];
                    let L1 = (n.r + c1.r) * SCALE;
                    let L2 = (n.r + c2.r) * SCALE;
                    let idealChord = Math.sqrt(L1*L1 + L2*L2 - 2*L1*L2*Math.cos(ang)); 

                    let dx = c2.x - c1.x, dy = c2.y - c1.y, dz = c2.z - c1.z;
                    let currentChord = Math.sqrt(dx*dx + dy*dy + dz*dz) || 0.001;
                    
                    let diff = (currentChord - idealChord) * 0.1; 
                    c1.x += (dx/currentChord) * diff; c1.y += (dy/currentChord) * diff; c1.z += (dz/currentChord) * diff;
                    c2.x -= (dx/currentChord) * diff; c2.y -= (dy/currentChord) * diff; c2.z -= (dz/currentChord) * diff;
                }
            }
        });
    }

    globalS = aC ? tS/aC : 0; meanAngle = aC ? tA/aC : 0;

    // ÈáçÂøÉ„ÇíÂõ∫ÂÆöÔºàÂÆáÂÆôÁ©∫Èñì„Åß„ÅÆ‰∏¶ÈÄ≤„ÇíÈò≤„ÅêÔºâ
    let cx=0, cy=0, cz=0; 
    nodes.forEach(n => { cx+=n.x; cy+=n.y; cz+=n.z; }); 
    cx/=nodes.length; cy/=nodes.length; cz/=nodes.length;
    nodes.forEach(n => { n.x-=cx; n.y-=cy; n.z-=cz; });

    draw(); 
    animId = requestAnimationFrame(runGeometrySolver);
}

// --- 3DÊìç‰Ωú„Å®ÊèèÁîª ---
let YAW=0.5, PIT=0.3, isDragging=false, lastX, lastY;
canvas.addEventListener('mousedown', e => { isDragging=true; lastX=e.clientX; lastY=e.clientY; });
window.addEventListener('mousemove', e => {
    if(!isDragging) return; 
    YAW += (e.clientX - lastX) * 0.01; PIT += (e.clientY - lastY) * 0.01; 
    lastX=e.clientX; lastY=e.clientY;
});
window.addEventListener('mouseup', () => isDragging=false);

canvas.addEventListener('touchstart', e => {
    if(e.target === canvas) { isDragging=true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }
}, {passive:true});
window.addEventListener('touchmove', e => {
    if(!isDragging) return; 
    YAW += (e.touches[0].clientX - lastX) * 0.01; PIT += (e.touches[0].clientY - lastY) * 0.01; 
    lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; 
    if(e.target === canvas) e.preventDefault(); 
}, {passive:false});
window.addEventListener('touchend', () => isDragging=false);

function draw(){
    if(!nodes.length) return;
    
    document.getElementById('dispCurrentS').innerText = globalS.toFixed(3);
    document.getElementById('dispAngle').innerText = meanAngle.toFixed(1) + "¬∞";
    let dist = Math.abs(targetS - globalS); 
    document.getElementById('dispDist').innerText = dist.toFixed(3);
    document.getElementById('dispDist').style.color = dist < 0.025 ? "var(--main)" : "var(--warn)";

    let count={}; curAtoms.forEach(a => count[a.s] = (count[a.s]||0)+1);
    document.getElementById('formulaDisplay').innerHTML = Object.keys(count).sort().map(s => s+(count[s]>1?`<sub>${count[s]}</sub>`:"")).join("");
    
    let rem = nodes.reduce((s,n) => s+n.rem, 0); 
    let badge = document.getElementById('stabilityBadge');
    badge.innerText = rem === 0 ? "ÊàêÁ´ã (STABLE)" : `Êú™ÊàêÁ´ã (${rem})`;
    badge.style.background = rem === 0 ? "var(--main)" : "#400"; 
    badge.style.color = rem === 0 ? "#000" : "var(--danger)";
    badge.style.borderColor = rem === 0 ? "var(--main)" : "var(--danger)";

    let zSum=0, pMax=0, pMin=10, potSum=0;
    nodes.forEach(n=>{ zSum+=n.z; potSum+=n.pot; if(n.en>pMax)pMax=n.en; if(n.en<pMin)pMin=n.en; });
    document.getElementById('propCond').innerText = (zSum/nodes.length).toFixed(1);
    document.getElementById('propPol').innerText = (pMax-pMin).toFixed(2);
    document.getElementById('propHard').innerText = (potSum/nodes.length).toFixed(1);

    nodes.forEach(n => {
        let x1 = n.x*Math.cos(YAW) - n.z*Math.sin(YAW), z1 = n.x*Math.sin(YAW) + n.z*Math.cos(YAW);
        let y1 = n.y*Math.cos(PIT) - z1*Math.sin(PIT), z2 = n.y*Math.sin(PIT) + z1*Math.cos(PIT);
        let sc = 750 / (750 + z2); 
        n.px2 = (canvas.offsetWidth/2) + x1*sc; n.py2 = (canvas.offsetHeight/2) + y1*sc;
        
        if(!document.getElementById(`n_${n.id}`)){
            let el = document.createElement('div'); el.className='node'; el.id=`n_${n.id}`; 
            el.innerText=n.s; el.style.background=n.c; canvas.appendChild(el);
        }
        let el = document.getElementById(`n_${n.id}`); 
        el.style.left = (n.px2-18)+"px"; el.style.top = (n.py2-18)+"px"; 
        el.style.transform = `scale(${sc})`; el.style.zIndex = Math.floor(1000-z2);
    });

    edges.forEach((e,i) => {
        if(!document.getElementById(`e_${i}`)){ 
            let l = document.createElement('div'); l.className='bond-line'; l.id=`e_${i}`; canvas.appendChild(l); 
        }
        let l = document.getElementById(`e_${i}`);
        let dx = e.t.px2 - e.s.px2, dy = e.t.py2 - e.s.py2, d = Math.sqrt(dx*dx + dy*dy);
        l.style.width = d + "px"; l.style.left = e.s.px2 + "px"; l.style.top = e.s.py2 + "px"; 
        l.style.transform = `rotate(${Math.atan2(dy,dx)*180/Math.PI}deg)`;
        l.style.zIndex = Math.floor(1000 - (e.s.z2 + e.t.z2)/2);
    });
}
updateUIValues();
</script>
</body>
</html>
