<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ID TENSOR: OMEGA ARCHITECT (MASTER)</title>
    <style>
        :root { --main: #00ffa3; --accent: #00d4ff; --warn: #ffcc00; --danger: #ff0055; --bg: #050505; --panel: #0d0d0d; --tensor: #b400ff;}
        body { background: var(--bg); color: #e0e0e0; font-family: sans-serif; padding: 10px; display: flex; flex-direction: column; align-items: center; margin: 0; overflow-x: hidden; }
        h1 { color: var(--main); border-bottom: 2px solid var(--main); padding-bottom: 5px; margin: 5px 0; text-shadow: 0 0 15px rgba(0,255,163,0.4); font-size: 1.4rem; letter-spacing: 2px;}
        .container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 320px 1fr; gap: 15px; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
        .panel { background: var(--panel); border: 1px solid #333; padding: 15px; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.5);}
        .panel-title { font-size: 0.8rem; color: #888; border-bottom: 1px dashed #444; padding-bottom: 5px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;}
        .slider-group { margin-bottom: 8px; }
        .slider-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa; margin-bottom: 2px; }
        input[type=range] { width: 100%; cursor: pointer; }
        .target-box { background: #110022; border: 1px solid var(--tensor); padding: 10px; border-radius: 6px; text-align: center; margin: 10px 0; }
        .target-val { font-size: 1.8rem; color: var(--tensor); font-weight: bold; font-family: monospace; }
        .btn { background: #1a1a1a; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.8rem; transition: 0.2s;}
        .btn:hover { border-color: var(--accent); color: var(--accent); background: #001122; }
        .btn-main { background: #001a11; border-color: var(--main); color: var(--main); width: 100%; margin-bottom: 10px; font-size: 0.9rem;}
        .btn-main:hover { background: var(--main); color: #000; box-shadow: 0 0 15px var(--main);}
        select { background: #111; color: #fff; border: 1px solid #444; padding: 8px; border-radius: 4px; font-family: monospace; margin-bottom: 10px; width: 100%; }
        .ingredient-list { display: flex; flex-wrap: wrap; gap: 5px; min-height: 45px; padding: 10px; background: #000; border: 1px solid #222; margin-bottom: 10px; border-radius: 4px;}
        .chip { background: #1a1a1a; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #444; display: flex; gap: 8px; align-items: center;}
        .del-btn { cursor: pointer; color: #666; font-weight: bold; } .del-btn:hover { color: var(--danger); }
        .dash-box { background: #0a0a0a; border: 1px solid #333; padding: 8px; border-radius: 6px; text-align: center; flex: 1; margin: 0 5px;}
        #networkCanvas { background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); border: 1px solid #333; width: 100%; min-height: 500px; border-radius: 6px; position: relative; overflow: hidden; margin-top: 10px; cursor: grab;}
        .node { position: absolute; width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85rem; border: 2px solid #fff; box-shadow: inset -3px -3px 8px rgba(0,0,0,0.6), 0 3px 10px rgba(0,0,0,0.8); }
        .bond-line { position: absolute; background: linear-gradient(90deg, #444, #888, #444); height: 4px; transform-origin: 0 50%; z-index: 1; pointer-events: none; border-radius: 2px; opacity: 0.7;}
    </style>
</head>
<body>
    <h1>ID TENSOR: OMEGA ARCHITECT</h1>
    <div class="container">
        <div class="panel">
            <div class="panel-title">1. Global Target</div>
            <div class="slider-group"><div class="slider-header"><span>Conductivity</span><span id="valCond">50%</span></div><input type="range" id="slCond" oninput="updateTarget()"></div>
            <div class="slider-group"><div class="slider-header"><span>Polarity</span><span id="valPol">50%</span></div><input type="range" id="slPol" oninput="updateTarget()"></div>
            <div class="slider-group"><div class="slider-header"><span>Hardness</span><span id="valHard">50%</span></div><input type="range" id="slHard" oninput="updateTarget()"></div>
            <div class="panel-title" style="margin-top:10px;">2. Thermodynamics</div>
            <div class="slider-group" style="background:#1a0000; padding:10px; border-radius:6px; border:1px solid #400;">
                <div class="slider-header"><span>Temp (K)</span><span id="valTemp" style="color:#f66">0 K</span></div>
                <input type="range" id="slTemp" min="0" max="1000" value="0" oninput="document.getElementById('valTemp').innerText=this.value+' K'">
            </div>
            <div class="target-box"><div style="font-size:0.7rem; color:#aaa;">Target S-Value</div><div class="target-val" id="dispTargetS">0.000</div></div>
            <button class="btn btn-main" onclick="suggestAtoms()">üîÆ Oracle Auto-Set</button>
        </div>

        <div class="panel">
            <div class="panel-title">3. Molecular Architect</div>
            
            <div style="background:#0a0a0a; padding:12px; border:1px solid #333; border-radius:6px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span style="font-size:0.6rem; color:#888; letter-spacing:1px; display:block;">MOLECULAR FORMULA</span>
                    <div id="formulaDisplay" style="font-size:1.6rem; font-weight:bold; color:var(--main); font-family:serif; text-shadow:0 0 10px rgba(0,255,163,0.3);">--</div>
                </div>
                <div id="stabilityBadge" style="padding:6px 16px; border-radius:4px; font-weight:bold; font-size:0.85rem; background:#222; color:#555; border:1px solid #444;">Êú™ÊàêÁ´ã</div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:10px;"><select id="elemSelect"></select><button class="btn" style="flex-shrink:0; padding:0 15px;" onclick="addElement()">Ôºã ËøΩÂä†</button><button class="btn" style="background:#220000; color:var(--danger); border-color:var(--danger);" onclick="clearList()">ÂÖ®Ê∂àÂéª</button></div>
            <div id="ingredientList" class="ingredient-list"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px;">
                <div class="dash-box"><div style="font-size:0.6rem; color:#888;">Êé®ÂÆö‰ºùÂ∞éÊÄß (Z-Avg)</div><div id="propCond" style="font-size:1rem; color:var(--accent);">--</div></div>
                <div class="dash-box"><div style="font-size:0.6rem; color:#888;">Ê•µÊÄßÂÅèÂ∑Æ (ŒîEN)</div><div id="propPol" style="font-size:1rem; color:var(--warn);">--</div></div>
                <div class="dash-box"><div style="font-size:0.6rem; color:#888;">ÊßãÈÄ†ÂâõÊÄß (Val-Avg)</div><div id="propHard" style="font-size:1rem; color:var(--main);">--</div></div>
                <div class="dash-box"><div style="font-size:0.6rem; color:#888;">S-Deviation</div><div id="dispDist" style="font-size:1rem; font-weight:bold;">0.000</div></div>
                <div class="dash-box" style="grid-column: span 2;"><div style="font-size:0.6rem; color:#888;">Current S-Value</div><div id="dispCurrentS" style="font-size:1.2rem; color:#fff; font-weight:bold;">0.000</div></div>
            </div>
            
            <div id="networkCanvas"></div>
        </div>
    </div>

<script>
const ELEMENTS_DB = [{z:1,s:'H',n:'Hydrogen',en:2.2,pot:1,c:'#FFFFFF'},{z:2,s:'He',n:'Helium',en:0,pot:0,c:'#D9FFFF'},{z:3,s:'Li',n:'Lithium',en:0.98,pot:1,c:'#CC80FF'},{z:4,s:'Be',n:'Beryllium',en:1.57,pot:2,c:'#C2FF00'},{z:5,s:'B',n:'Boron',en:2.04,pot:3,c:'#FFB5B5'},{z:6,s:'C',n:'Carbon',en:2.55,pot:4,c:'#909090'},{z:7,s:'N',n:'Nitrogen',en:3.04,pot:3,c:'#3050F8'},{z:8,s:'O',n:'Oxygen',en:3.44,pot:2,c:'#FF0D0D'},{z:9,s:'F',n:'Fluorine',en:3.98,pot:1,c:'#90E050'},{z:10,s:'Ne',n:'Neon',en:0,pot:0,c:'#B3E3F5'},{z:11,s:'Na',n:'Sodium',en:0.93,pot:1,c:'#AB5CF2'},{z:12,s:'Mg',n:'Magnesium',en:1.31,pot:2,c:'#8AFF00'},{z:13,s:'Al',n:'Aluminium',en:1.61,pot:3,c:'#BFA6A6'},{z:14,s:'Si',n:'Silicon',en:1.9,pot:4,c:'#F0C8A0'},{z:15,s:'P',n:'Phosphorus',en:2.19,pot:5,c:'#FF8000'},{z:16,s:'S',n:'Sulfur',en:2.58,pot:6,c:'#FFFF30'},{z:17,s:'Cl',n:'Chlorine',en:3.16,pot:1,c:'#1FF01F'},{z:18,s:'Ar',n:'Argon',en:0,pot:0,c:'#80D1E3'},{z:19,s:'K',n:'Potassium',en:0.82,pot:1,c:'#8F40D4'},{z:20,s:'Ca',n:'Calcium',en:1,pot:2,c:'#3DFF00'},{z:21,s:'Sc',n:'Scandium',en:1.36,pot:3,c:'#E6E6E6'},{z:22,s:'Ti',n:'Titanium',en:1.54,pot:4,c:'#BFC2C7'},{z:23,s:'V',n:'Vanadium',en:1.63,pot:4,c:'#A6A6AB'},{z:24,s:'Cr',n:'Chromium',en:1.66,pot:6,c:'#8A99C7'},{z:25,s:'Mn',n:'Manganese',en:1.55,pot:7,c:'#9C7AC7'},{z:26,s:'Fe',n:'Iron',en:1.83,pot:3,c:'#E06633'},{z:27,s:'Co',n:'Cobalt',en:1.88,pot:2,c:'#F090A0'},{z:28,s:'Ni',n:'Nickel',en:1.91,pot:2,c:'#50D050'},{z:29,s:'Cu',n:'Copper',en:1.9,pot:2,c:'#C88033'},{z:30,s:'Zn',n:'Zinc',en:1.65,pot:2,c:'#7D80B0'},{z:31,s:'Ga',n:'Gallium',en:1.81,pot:3,c:'#C28F8F'},{z:32,s:'Ge',n:'Germanium',en:2.01,pot:4,c:'#668F8F'},{z:33,s:'As',n:'Arsenic',en:2.18,pot:5,c:'#BD80E3'},{z:34,s:'Se',n:'Selenium',en:2.55,pot:2,c:'#FFA100'},{z:35,s:'Br',n:'Bromine',en:2.96,pot:1,c:'#A62929'},{z:36,s:'Kr',n:'Krypton',en:0,pot:0,c:'#5CB8D1'},{z:37,s:'Rb',n:'Rubidium',en:0.82,pot:1,c:'#702EB0'},{z:38,s:'Sr',n:'Strontium',en:0.95,pot:2,c:'#00FF00'},{z:39,s:'Y',n:'Yttrium',en:1.22,pot:3,c:'#94FFFF'},{z:40,s:'Zr',n:'Zirconium',en:1.33,pot:4,c:'#94E0E0'},{z:41,s:'Nb',n:'Niobium',en:1.6,pot:5,c:'#73C2C9'},{z:42,s:'Mo',n:'Molybdenum',en:2.16,pot:6,c:'#54B5B5'},{z:43,s:'Tc',n:'Technetium',en:1.9,pot:7,c:'#3B9E9E'},{z:44,s:'Ru',n:'Ruthenium',en:2.2,pot:4,c:'#248F8F'},{z:45,s:'Rh',n:'Rhodium',en:2.28,pot:3,c:'#0A7D8C'},{z:46,s:'Pd',n:'Palladium',en:2.2,pot:2,c:'#006985'},{z:47,s:'Ag',n:'Silver',en:1.93,pot:1,c:'#C0C0C0'},{z:48,s:'Cd',n:'Cadmium',en:1.69,pot:2,c:'#FFD98F'},{z:49,s:'In',n:'Indium',en:1.78,pot:3,c:'#A67573'},{z:50,s:'Sn',n:'Tin',en:1.96,pot:4,c:'#668080'},{z:51,s:'Sb',n:'Antimony',en:2.05,pot:3,c:'#9E63B5'},{z:52,s:'Te',n:'Tellurium',en:2.1,pot:2,c:'#D47A00'},{z:53,s:'I',n:'Iodine',en:2.66,pot:1,c:'#940094'},{z:54,s:'Xe',n:'Xenon',en:0,pot:0,c:'#429EB0'},{z:55,s:'Cs',n:'Caesium',en:0.79,pot:1,c:'#57178F'},{z:56,s:'Ba',n:'Barium',en:0.89,pot:2,c:'#00C900'},{z:57,s:'La',n:'Lanthanum',en:1.1,pot:3,c:'#70D4FF'},{z:58,s:'Ce',n:'Cerium',en:1.12,pot:3,c:'#FFFFC7'},{z:59,s:'Pr',n:'Praseodymium',en:1.13,pot:3,c:'#D9FFC7'},{z:60,s:'Nd',n:'Neodymium',en:1.14,pot:3,c:'#C7FFC7'},{z:61,s:'Pm',n:'Promethium',en:1.13,pot:3,c:'#A3FFC7'},{z:62,s:'Sm',n:'Samarium',en:1.17,pot:3,c:'#8FFFC7'},{z:63,s:'Eu',n:'Europium',en:1.2,pot:3,c:'#61FFC7'},{z:64,s:'Gd',n:'Gadolinium',en:1.2,pot:3,c:'#45FFC7'},{z:65,s:'Tb',n:'Terbium',en:1.2,pot:3,c:'#30FFC7'},{z:66,s:'Dy',n:'Dysprosium',en:1.22,pot:3,c:'#1FFFC7'},{z:67,s:'Ho',n:'Holmium',en:1.23,pot:3,c:'#00FF9C'},{z:68,s:'Er',n:'Erbium',en:1.24,pot:3,c:'#00E675'},{z:69,s:'Tm',n:'Thulium',en:1.25,pot:3,c:'#00D452'},{z:70,s:'Yb',n:'Ytterbium',en:1.1,pot:3,c:'#00BF38'},{z:71,s:'Lu',n:'Lutetium',en:1.27,pot:3,c:'#00AB24'},{z:72,s:'Hf',n:'Hafnium',en:1.3,pot:4,c:'#4DC2FF'},{z:73,s:'Ta',n:'Tantalum',en:1.5,pot:5,c:'#4DA6FF'},{z:74,s:'W',n:'Tungsten',en:2.36,pot:6,c:'#2194D6'},{z:75,s:'Re',n:'Rhenium',en:1.9,pot:4,c:'#267DAB'},{z:76,s:'Os',n:'Osmium',en:2.2,pot:4,c:'#266696'},{z:77,s:'Ir',n:'Iridium',en:2.2,pot:3,c:'#175487'},{z:78,s:'Pt',n:'Platinum',en:2.28,pot:2,c:'#D0D0E0'},{z:79,s:'Au',n:'Gold',en:2.54,pot:3,c:'#FFD123'},{z:80,s:'Hg',n:'Mercury',en:2,pot:2,c:'#B8B8D0'},{z:81,s:'Tl',n:'Thallium',en:1.62,pot:1,c:'#A6544D'},{z:82,s:'Pb',n:'Lead',en:2.33,pot:4,c:'#575961'},{z:83,s:'Bi',n:'Bismuth',en:2.02,pot:3,c:'#9E4FB5'},{z:84,s:'Po',n:'Polonium',en:2,pot:2,c:'#AB5C00'},{z:85,s:'At',n:'Astatine',en:2.2,pot:1,c:'#754F45'},{z:86,s:'Rn',n:'Radon',en:0,pot:0,c:'#428296'},{z:87,s:'Fr',n:'Francium',en:0.7,pot:1,c:'#420066'},{z:88,s:'Ra',n:'Radium',en:0.9,pot:2,c:'#007D00'},{z:89,s:'Ac',n:'Actinium',en:1.1,pot:3,c:'#70ABFA'},{z:90,s:'Th',n:'Thorium',en:1.3,pot:4,c:'#00BAFF'},{z:91,s:'Pa',n:'Protactinium',en:1.5,pot:5,c:'#00A1FF'},{z:92,s:'U',n:'Uranium',en:1.38,pot:6,c:'#008FFF'},{z:93,s:'Np',n:'Neptunium',en:1.36,pot:5,c:'#0080FF'},{z:94,s:'Pu',n:'Plutonium',en:1.28,pot:4,c:'#006BFF'},{z:95,s:'Am',n:'Americium',en:1.3,pot:3,c:'#545CF2'},{z:96,s:'Cm',n:'Curium',en:1.3,pot:3,c:'#785CE3'},{z:97,s:'Bk',n:'Berkelium',en:1.3,pot:3,c:'#8A4FE3'},{z:98,s:'Cf',n:'Californium',en:1.3,pot:3,c:'#A136D4'},{z:99,s:'Es',n:'Einsteinium',en:1.3,pot:3,c:'#B31FD4'},{z:100,s:'Fm',n:'Fermium',en:1.3,pot:3,c:'#B31FBA'},{z:101,s:'Md',n:'Mendelevium',en:1.3,pot:3,c:'#B30DA6'},{z:102,s:'No',n:'Nobelium',en:1.3,pot:3,c:'#BD0D87'},{z:103,s:'Lr',n:'Lawrencium',en:1.3,pot:3,c:'#C70066'},{z:104,s:'Rf',n:'Rutherfordium',en:1.3,pot:4,c:'#CC0059'},{z:105,s:'Db',n:'Dubnium',en:1.3,pot:5,c:'#D1004F'},{z:106,s:'Sg',n:'Seaborgium',en:1.3,pot:6,c:'#D90045'},{z:107,s:'Bh',n:'Bohrium',en:1.3,pot:7,c:'#E00038'},{z:108,s:'Hs',n:'Hassium',en:1.3,pot:8,c:'#E6002E'},{z:109,s:'Mt',n:'Meitnerium',en:1.3,pot:4,c:'#EB0026'},{z:110,s:'Ds',n:'Darmstadtium',en:1.3,pot:2,c:'#F0001C'},{z:111,s:'Rg',n:'Roentgenium',en:1.3,pot:3,c:'#F50014'},{z:112,s:'Cn',n:'Copernicium',en:1.3,pot:2,c:'#FA000A'},{z:113,s:'Nh',n:'Nihonium',en:1.3,pot:3,c:'#FF0000'},{z:114,s:'Fl',n:'Flerovium',en:1.3,pot:4,c:'#FF0000'},{z:115,s:'Mc',n:'Moscovium',en:1.3,pot:3,c:'#FF0000'},{z:116,s:'Lv',n:'Livermorium',en:1.3,pot:4,c:'#FF0000'},{z:117,s:'Ts',n:'Tennessine',en:1.3,pot:1,c:'#FF0000'},{z:118,s:'Og',n:'Oganesson',en:1.3,pot:0,c:'#FF0000'}];

let uidCount=0, currentAtoms=[], activeNodes=[], activeEdges=[], targetS=0, animId;
const canvas = document.getElementById('networkCanvas');
const sel = document.getElementById('elemSelect');

ELEMENTS_DB.forEach(el => { 
    let opt=document.createElement('option'); opt.value=el.z; 
    opt.text=`[${String(el.z).padStart(3,'0')}] ${el.s} - ${el.n}`; 
    if(el.z==6)opt.selected=true; sel.appendChild(opt); 
});

function updateTarget() { 
    let c=document.getElementById('slCond').value/100, p=document.getElementById('slPol').value/100, h=document.getElementById('slHard').value/100; 
    targetS=((c*0.333)+(p*0.185)+(h*0.250))/(c+p+h||1); 
    document.getElementById('dispTargetS').innerText=targetS.toFixed(3); 
}

function addElement() { let d=Object.assign({},ELEMENTS_DB.find(e=>e.z==sel.value)); d.uid=uidCount++; currentAtoms.push(d); updateList(); runAssembly(); }
function removeNode(uid) { currentAtoms=currentAtoms.filter(a=>a.uid!=uid); updateList(); runAssembly(); }
function updateList() { let l=document.getElementById('ingredientList'); l.innerHTML=""; currentAtoms.forEach(a=>{ let d=document.createElement('div'); d.className='chip'; d.innerHTML=`<b style="color:${a.c}">${a.s}</b><span class='del-btn' onclick='removeNode(${a.uid})'>√ó</span>`; l.appendChild(d); }); }
function clearList() { currentAtoms=[]; activeNodes=[]; activeEdges=[]; updateList(); canvas.innerHTML=''; }

function suggestAtoms() {
    currentAtoms=[]; 
    let c=document.getElementById('slCond').value/100, p=document.getElementById('slPol').value/100, h=document.getElementById('slHard').value/100;
    let sum = c + p + h + 0.01; let wCond = c/sum, wPol = p/sum, wHard = h/sum;
    let metals = [26, 29, 47, 78, 79, 92]; let networks = [5, 6, 14, 15, 16]; let polars_core = [7, 8]; let terms = [1, 9, 17];
    
    let coreCount = Math.floor(Math.random() * 6) + 3;
    let cores = []; let potSum = 0;
    for(let i=0; i<coreCount; i++) {
        let r = Math.random(), z = 6;
        if(r < wCond) z = metals[Math.floor(Math.random() * metals.length)];
        else if(r < wCond + wHard) z = networks[Math.floor(Math.random() * networks.length)];
        else z = polars_core[Math.floor(Math.random() * polars_core.length)];
        let def = ELEMENTS_DB.find(e=>e.z==z); if(def) { cores.push(def); potSum += def.pot; }
    }
    
    let requiredTerms = potSum - 2 * (cores.length - 1);
    let doubleBonds = Math.floor(Math.random() * 3); 
    if (requiredTerms - (doubleBonds * 2) >= 0) requiredTerms -= (doubleBonds * 2); else requiredTerms = requiredTerms % 2;
    
    cores.forEach(def => currentAtoms.push({...def, uid:uidCount++}));
    for(let i=0; i<requiredTerms; i++) {
        let r = Math.random(), z = 1; if(r < wPol) z = terms[Math.floor(Math.random() * terms.length)];
        let def = ELEMENTS_DB.find(e=>e.z==z); if(def) currentAtoms.push({...def, uid:uidCount++});
    }
    updateList(); runAssembly();
}

function runAssembly() {
    if(currentAtoms.length==0) { canvas.innerHTML=''; return; }
    let nodes = currentAtoms.map(a => { let ex=activeNodes.find(n=>n.uid==a.uid); return { ...a, type:a.s, color:a.c, cur:a.pot, conns:[], x: ex?ex.x:(Math.random()-0.5)*50, y: ex?ex.y:(Math.random()-0.5)*50, z: ex?ex.z:(Math.random()-0.5)*50, px: ex?ex.x:0, py: ex?ex.y:0, pz: ex?ex.z:0 }; });
    let edges = [];
    function bond(n1,n2,a){ if(n1.cur<a||n2.cur<a)return; n1.cur-=a;n2.cur-=a; let e=edges.find(x=>(x.s.uid==n1.uid&&x.t.uid==n2.uid)||(x.s.uid==n2.uid&&x.t.uid==n1.uid)); if(e){e.type+=a; n1.conns.find(c=>c.uid==n2.uid).type+=a; n2.conns.find(c=>c.uid==n1.uid).type+=a;} else {edges.push({s:n1,t:n2,type:a}); n1.conns.push({uid:n2.uid,type:a}); n2.conns.push({uid:n1.uid,type:a});} }
    
    let cores=nodes.filter(n=>n.pot>1), terms=nodes.filter(n=>n.pot==1);
    if(cores.length>1){ let cn=[cores[0]], un=cores.slice(1); while(un.length>0){ cn.sort((a,b)=>b.cur-a.cur); let s=cn.find(n=>n.cur>0)||cn[0]; un.sort((a,b)=>b.cur-a.cur); let t=un.shift(); bond(s,t,1); cn.push(t); }}
    for(let t of terms){ let av=nodes.filter(n=>n.uid!=t.uid&&n.cur>0); if(av.length>0){ av.sort((a,b)=>(b.pot>1?1:0)-(a.pot>1?1:0)||b.cur-a.cur); bond(t,av[0],1); }}
    
    let comp=true; 
    while(comp){ 
        comp=false; let oc=nodes.filter(n=>n.cur>0&&n.pot>1); 
        if(oc.length>=2){ 
            for(let c of oc){ let nbs=c.conns.map(x=>nodes.find(n=>n.uid==x.uid)).filter(n=>n.cur>0&&n.pot>1); if(nbs.length>0){ nbs.sort((a,b)=>b.cur-a.cur); let e=edges.find(x=>(x.s.uid==c.uid&&x.t.uid==nbs[0].uid)||(x.s.uid==nbs[0].uid&&x.t.uid==c.uid)); if(e&&e.type<3){ bond(c,nbs[0],1); comp=true; break; } } }
            if(!comp){ for(let i=0;i<oc.length;i++){ for(let j=i+1;j<oc.length;j++){ if(oc[i].cur>0&&oc[j].cur>0){ let e=edges.find(x=>(x.s.uid==oc[i].uid&&x.t.uid==oc[j].uid)||(x.s.uid==oc[j].uid&&x.t.uid==oc[i].uid)); if(!e){ bond(oc[i],oc[j],1); comp=true; break; } } } if(comp) break; } } 
        } 
    }
    activeNodes=nodes; activeEdges=edges; canvas.innerHTML=''; if(!animId) anim();
}

function anim() { 
    const IDEAL_L=65, BOUND=160; let temp=document.getElementById('slTemp').value;
    
    // üåü „Éñ„É¨„Éº„Ç≠Âº∑Âåñ ÔºÜ Èõ∂ÁÇπÊåØÂãï üåü
    let damp = temp > 5 ? 0.95 : 0.60; 
    let noise = (temp / 1000) * 1.5 + (temp < 5 ? 0.03 : 0);

    activeNodes.forEach(n=>{ 
        let vx=(n.x-n.px)*damp, vy=(n.y-n.py)*damp, vz=(n.z-n.pz)*damp; 
        vx = Math.max(-10, Math.min(10, vx)); vy = Math.max(-10, Math.min(10, vy)); vz = Math.max(-10, Math.min(10, vz)); // „Çπ„Éî„Éº„Éâ„É™„Éü„ÉÉ„Çø„Éº
        n.px=n.x; n.py=n.y; n.pz=n.z; 
        n.x += vx + (Math.random()-0.5)*noise; n.y += vy + (Math.random()-0.5)*noise; n.z += vz + (Math.random()-0.5)*noise; 
        if(Math.abs(n.x)>BOUND) n.x=Math.sign(n.x)*BOUND; if(Math.abs(n.y)>BOUND) n.y=Math.sign(n.y)*BOUND; if(Math.abs(n.z)>BOUND) n.z=Math.sign(n.z)*BOUND; 
    });
    
    for(let k=0; k<5; k++){
        activeEdges.forEach(e=>{ 
            let dx=e.t.x-e.s.x, dy=e.t.y-e.s.y, dz=e.t.z-e.s.z, d=Math.sqrt(dx*dx+dy*dy+dz*dz)||0.001, diff=d-(IDEAL_L-(e.type-1)*12), corr=diff*0.5; 
            e.s.x+=dx/d*corr; e.s.y+=dy/d*corr; e.s.z+=dz/d*corr; e.t.x-=dx/d*corr; e.t.y-=dy/d*corr; e.t.z-=dz/d*corr; 
        });
        
        activeNodes.forEach(a=>{ 
            let nbs=a.conns.map(c=>activeNodes.find(n=>n.uid==c.uid)).filter(n=>n); if(nbs.length<2) return;
            let ang = a.pot>=4 ? 109.5 : (a.pot==3 ? 120 : (a.pot==2 ? 104.5 : 90)); if (a.pot >= 5) ang = 90;
            let iD = Math.sqrt(2*IDEAL_L*IDEAL_L*(1-Math.cos(ang*Math.PI/180)));
            for(let i=0;i<nbs.length;i++){ 
                for(let j=i+1;j<nbs.length;j++){ 
                    let b=nbs[i], c=nbs[j], dx=c.x-b.x, dy=c.y-b.y, dz=c.z-b.z, d=Math.sqrt(dx*dx+dy*dy+dz*dz)||0.001;
                    if (d < iD) { let corr = (iD-d) * 0.02; b.x -= dx/d*corr; b.y -= dy/d*corr; b.z -= dz/d*corr; c.x += dx/d*corr; c.y += dy/d*corr; c.z += dz/d*corr; } // „Ç∑„Éß„ÉÉ„ÇØ„Ç¢„Éñ„ÇΩ„Éº„Éê„Éº
                }
            }
        });
    }
    let cx=0, cy=0, cz=0; activeNodes.forEach(n=>{cx+=n.x; cy+=n.y; cz+=n.z;}); cx/=activeNodes.length||1; cy/=activeNodes.length||1; cz/=activeNodes.length||1; activeNodes.forEach(n=>{n.x-=cx; n.y-=cy; n.z-=cz;});
    
    updateDisplay(); animId=requestAnimationFrame(anim);
}

// üåü VIEW ENGINE & SUPERCONDUCTIVITY üåü
let CAM_PITCH = -20 * Math.PI/180, CAM_YAW = 25 * Math.PI/180;
let isDragging = false, lastMouseX = 0, lastMouseY = 0;
const startDrag = (x, y) => { isDragging = true; lastMouseX = x; lastMouseY = y; };
const moveDrag = (x, y) => { if (!isDragging) return; CAM_YAW += (x - lastMouseX) * 0.01; CAM_PITCH = Math.max(-1.5, Math.min(1.5, CAM_PITCH + (y - lastMouseY) * 0.01)); lastMouseX = x; lastMouseY = y; };
canvas.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY)); window.addEventListener('mousemove', (e) => moveDrag(e.clientX, e.clientY)); window.addEventListener('mouseup', () => isDragging = false);
canvas.addEventListener('touchstart', (e) => { if(e.target === canvas) { startDrag(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); } }, {passive:false});
window.addEventListener('touchmove', (e) => { if(isDragging) { moveDrag(e.touches[0].clientX, e.touches[0].clientY); e.preventDefault(); } }, {passive:false}); window.addEventListener('touchend', () => isDragging = false);

function updateDisplay() {
    let tS=0, c=0, totalEN=0, minEN=10, maxEN=0, totalZ=0, totalVal=0;
    activeNodes.forEach(a=>{
        if(a.conns.length>=2){
            let sS=0, ac=0;
            for(let i=0;i<a.conns.length;i++){ for(let j=i+1;j<a.conns.length;j++){ let n1=activeNodes.find(n=>n.uid==a.conns[i].uid), n2=activeNodes.find(n=>n.uid==a.conns[j].uid); if(!n1||!n2)continue; let dx1=n1.x-a.x,dy1=n1.y-a.y,dz1=n1.z-a.z, dx2=n2.x-a.x,dy2=n2.y-a.y,dz2=n2.z-a.z, m1=Math.sqrt(dx1*dx1+dy1*dy1+dz1*dz1), m2=Math.sqrt(dx2*dx2+dy2*dy2+dz2*dz2); if(m1>0&&m2>0){ let ct=Math.max(-1,Math.min(1,(dx1*dx2+dy1*dy2+dz1*dz2)/(m1*m2))); if(Math.abs(ct-1)>0.001) sS+=Math.abs(ct/(ct-1)); ac++; } } }
            if(ac>0){ tS+=(sS/ac); c++; }
        }
        totalEN += a.en; if(a.en > 0) { minEN = Math.min(minEN, a.en); maxEN = Math.max(maxEN, a.en); }
        totalZ += a.z; totalVal += a.pot;
    });
    
    let curS = c>0 ? tS/c : 0; document.getElementById('dispCurrentS').innerText = curS.toFixed(3);
    let dist = Math.abs(targetS - curS); let db = document.getElementById('dispDist'); db.innerText = dist.toFixed(3); db.style.color = dist <= 0.025 ? "var(--main)" : "var(--danger)";

    let avgZ = activeNodes.length ? totalZ / activeNodes.length : 0; let avgVal = activeNodes.length ? totalVal / activeNodes.length : 0;
    if(activeNodes.length > 0) {
        document.getElementById('propCond').innerText = avgZ.toFixed(1) + " (idx)"; document.getElementById('propPol').innerText = (maxEN - minEN).toFixed(2) + " ŒîEN"; document.getElementById('propHard').innerText = avgVal.toFixed(1) + " /node";
    } else {
        document.getElementById('propCond').innerText = "--"; document.getElementById('propPol').innerText = "--"; document.getElementById('propHard').innerText = "--";
    }

    let isMetallic = avgZ > 20; let isComplex = activeNodes.length >= 10 && avgVal > 2.0; let isStable = dist <= 0.04;
    let tempK = document.getElementById('slTemp').value;
    let isSuperConducting = (isMetallic && tempK < 30) || (isMetallic && isComplex && isStable && tempK < 305);

    let counts = {}; currentAtoms.forEach(a=>{ counts[a.s]=(counts[a.s]||0)+1; });
    let syms = Object.keys(counts).sort((a,b)=> a==='C'?-1:b==='C'?1:a==='H'?-1:b==='H'?1:a.localeCompare(b));
    let html=""; syms.forEach(s=>{ html+=s+(counts[s]>1?`<sub>${counts[s]}</sub>`:""); });
    let fDisp = document.getElementById('formulaDisplay'); if(fDisp) fDisp.innerHTML=html || "--";
    
    let leftovers = activeNodes.reduce((s,n)=>s+n.cur,0); let badge = document.getElementById('stabilityBadge');
    if(badge) {
        if(leftovers===0 && activeNodes.length>0) { badge.innerText="ÊàêÁ´ã (Stable)"; badge.style.background="var(--main)"; badge.style.color="#000"; }
        else { badge.innerText=`Êú™ÊàêÁ´ã (${leftovers})`; badge.style.background="#300"; badge.style.color="var(--danger)"; }
    }

    let mx=0,my=0,mz=0; activeNodes.forEach(n=>{mx+=n.x;my+=n.y;mz+=n.z;}); mx/=activeNodes.length||1; my/=activeNodes.length||1; mz/=activeNodes.length||1;
    let mr=50; activeNodes.forEach(n=>{let r=Math.sqrt((n.x-mx)**2+(n.y-my)**2+(n.z-mz)**2); if(r>mr)mr=r;}); let zR=Math.min(1.2, 180/mr);
    activeNodes.forEach(n=>{
        let tx=n.x-mx, ty=n.y-my, tz=n.z-mz, x1=tx*Math.cos(CAM_YAW)-tz*Math.sin(CAM_YAW), z1=tx*Math.sin(CAM_YAW)+tz*Math.cos(CAM_YAW), y1=ty*Math.cos(CAM_PITCH)-z1*Math.sin(CAM_PITCH), z2=ty*Math.sin(CAM_PITCH)+z1*Math.cos(CAM_PITCH);
        n.sc=(800/(800+z2))*zR; n.px2=(canvas.offsetWidth/2)+x1*n.sc; n.py2=(canvas.offsetHeight/2)+y1*n.sc; n.pz2=z2;
    });
    
    if(canvas.childElementCount==0){
        activeEdges.forEach((e,i)=>{ let l=document.createElement('div'); l.className='bond-line'; l.id=`e_${i}`; canvas.appendChild(l); });
        activeNodes.forEach(n=>{ 
            let el=document.createElement('div'); el.className='node'; el.innerText=n.type; el.style.background=n.color;
            let r=parseInt(n.color.substring(1,3),16), g=parseInt(n.color.substring(3,5),16), b=parseInt(n.color.substring(5,7),16);
            el.style.color=(r*299+g*587+b*114)/1000 > 128 ? '#000':'#fff'; el.id=`n_${n.uid}`; el.ondblclick=()=>removeNode(n.uid); canvas.appendChild(el); 
        });
    }
    
    activeNodes.forEach(n=>{ let el=document.getElementById(`n_${n.uid}`); if(el){ el.style.left=(n.px2-17)+"px"; el.style.top=(n.py2-17)+"px"; el.style.transform=`scale(${n.sc})`; el.style.filter=`brightness(${Math.max(0.5,1-(n.pz2/300))})`; el.style.zIndex=Math.floor(100-n.pz2); }});
    activeEdges.forEach((e,i)=>{ 
        let el=document.getElementById(`e_${i}`); 
        if(el){ 
            let dx=e.t.px2-e.s.px2, dy=e.t.py2-e.s.py2; el.style.width=Math.sqrt(dx*dx+dy*dy)+"px"; el.style.left=e.s.px2+"px"; el.style.top=e.s.py2+"px"; el.style.transform=`rotate(${Math.atan2(dy,dx)*180/Math.PI}deg)`; el.style.zIndex=Math.floor(50-(e.s.pz2+e.t.pz2)/2);
            if(isSuperConducting) { el.style.background="linear-gradient(90deg, var(--accent), #fff, var(--accent))"; el.style.boxShadow="0 0 8px var(--accent)"; el.style.opacity="1.0"; }
            else { el.style.background="linear-gradient(90deg, #444, #888, #444)"; el.style.boxShadow="none"; el.style.opacity="0.7"; }
        }
    });
}
updateTarget();
</script>
</body>
</html>
